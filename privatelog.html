<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Private Log</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background-color: #121212;
            color: white;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .header {
            text-align: center;
            padding: 15px;
            font-size: 1.5rem;
            font-weight: bold;
            background-color: #1e1e1e;
        }
        
        .camera-container {
            flex: 1;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        
        #videoElement {
            width: 100%;
            height: 100%;
            object-fit: contain; /* Changed from cover to contain */
            background-color: #000;
        }
        
        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        
        .overlay-title {
            position: absolute;
            top: 15px;
            left: 15px;
            font-size: 18px;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.8);
        }
        
        .overlay-time {
            position: absolute;
            bottom: 15px;
            right: 15px;
            font-size: 14px;
            color: white;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.8);
        }
        
        .controls {
            padding: 20px;
            display: flex;
            justify-content: center;
            background-color: #1e1e1e;
        }
        
        #recordButton {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background-color: #ff3b30;
            border: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: transform 0.2s, background-color 0.3s;
        }
        
        #recordButton:active {
            transform: scale(0.95);
        }
        
        #recordButton.recording {
            background-color: #ff6961;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .message {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .message.show {
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="header">Private Log</div>
    
    <div class="camera-container">
        <video id="videoElement" autoplay muted playsinline></video>
        <div class="overlay">
            <div class="overlay-title">Private Log</div>
            <div class="overlay-time" id="currentTime"></div>
        </div>
    </div>
    
    <div class="controls">
        <button id="recordButton"></button>
    </div>
    
    <div class="message" id="message"></div>
    
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const videoElement = document.getElementById('videoElement');
            const recordButton = document.getElementById('recordButton');
            const timeDisplay = document.getElementById('currentTime');
            const messageElement = document.getElementById('message');
            
            let stream = null;
            let mediaRecorder = null;
            let recordedChunks = [];
            let isRecording = false;
            let timeInterval = null;
            
            // Function to update time display
            function updateTime() {
                const now = new Date();
                const options = { 
                    year: 'numeric', 
                    month: '2-digit', 
                    day: '2-digit',
                    hour: '2-digit', 
                    minute: '2-digit', 
                    second: '2-digit',
                    hour12: false
                };
                timeDisplay.textContent = now.toLocaleString(undefined, options);
            }
            
            // Update time immediately and then every second
            updateTime();
            setInterval(updateTime, 1000);
            
            // Function to show message
            function showMessage(text, duration = 3000) {
                messageElement.textContent = text;
                messageElement.classList.add('show');
                setTimeout(() => {
                    messageElement.classList.remove('show');
                }, duration);
            }
            
            // Function to initialize camera
            async function initCamera() {
                try {
                    // Try to get the front camera on mobile devices with portrait orientation
                    const constraints = {
                        video: {
                            facingMode: { ideal: "user" },
                            width: { ideal: 1080 },
                            height: { ideal: 1920 } // Prioritize portrait aspect ratio
                        },
                        audio: true
                    };
                    
                    stream = await navigator.mediaDevices.getUserMedia(constraints);
                    videoElement.srcObject = stream;
                    
                    // Enable the record button once camera is ready
                    recordButton.disabled = false;
                    
                    showMessage("Camera ready");
                } catch (err) {
                    console.error("Error accessing camera:", err);
                    showMessage("Error accessing camera. Please check permissions.", 5000);
                }
            }
            
            // Function to start recording
            function startRecording() {
                recordedChunks = [];
                
                // Create a canvas to draw video with overlaid text
                const canvas = document.createElement('canvas');
                
                // Set canvas dimensions to match video dimensions (maintaining aspect ratio)
                const videoWidth = videoElement.videoWidth;
                const videoHeight = videoElement.videoHeight;
                canvas.width = videoWidth;
                canvas.height = videoHeight;
                
                const ctx = canvas.getContext('2d');
                
                // Create a stream from the canvas
                const canvasStream = canvas.captureStream(30); // 30fps
                
                // Add audio track from the original stream to the canvas stream
                if (stream.getAudioTracks().length > 0) {
                    canvasStream.addTrack(stream.getAudioTracks()[0]);
                }
                
                // Set up media recorder with canvas stream
                mediaRecorder = new MediaRecorder(canvasStream, {
                    mimeType: 'video/webm;codecs=vp9,opus'
                });
                
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        recordedChunks.push(event.data);
                    }
                };
                
                mediaRecorder.onstop = saveVideo;
                
                // Start drawing frames to canvas
                const drawFrame = () => {
                    if (!isRecording) return;
                    
                    // Draw the video frame
                    ctx.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
                    
                    // Draw the overlay text
                    ctx.fillStyle = 'white';
                    ctx.shadowColor = 'rgba(0, 0, 0, 0.8)';
                    ctx.shadowBlur = 3;
                    ctx.shadowOffsetX = 1;
                    ctx.shadowOffsetY = 1;
                    
                    // Title
                    ctx.font = 'bold 20px sans-serif';
                    ctx.textAlign = 'left';
                    ctx.fillText('Private Log', 15, 30);
                    
                    // Time
                    ctx.font = '14px sans-serif';
                    ctx.textAlign = 'right';
                    ctx.fillText(timeDisplay.textContent, canvas.width - 15, canvas.height - 15);
                    
                    // Continue drawing
                    requestAnimationFrame(drawFrame);
                };
                
                // Start recording
                mediaRecorder.start(1000); // Collect data every second
                isRecording = true;
                recordButton.classList.add('recording');
                showMessage("Recording started");
                
                // Start drawing frames
                drawFrame();
            }
            
            // Function to stop recording
            function stopRecording() {
                if (mediaRecorder && isRecording) {
                    mediaRecorder.stop();
                    isRecording = false;
                    recordButton.classList.remove('recording');
                    showMessage("Recording stopped");
                }
            }
            
            // Function to save video
            function saveVideo() {
                const blob = new Blob(recordedChunks, { type: 'video/webm' });
                
                // Create a timestamp for the filename
                const now = new Date();
                const timestamp = now.toISOString().replace(/[:.]/g, '-');
                const filename = `private-log-${timestamp}.webm`;
                
                // Create download link
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                
                // Clean up
                setTimeout(() => {
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    showMessage("Video saved to downloads");
                }, 100);
            }
            
            // Initialize camera when page loads
            initCamera();
            
            // Set up record button click handler
            recordButton.addEventListener('click', () => {
                if (!isRecording) {
                    startRecording();
                } else {
                    stopRecording();
                }
            });
            
            // Handle page visibility changes to stop recording when page is hidden
            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'hidden' && isRecording) {
                    stopRecording();
                    showMessage("Recording stopped due to app switching");
                }
            });
        });
    </script>
</body>
</html>
